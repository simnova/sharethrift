---
sidebar_position: 3
sidebar_label: 0002 Malware Scanning
description: "Uploaded files must be scanned for malware before being accepted onto the platform"
status: pending
contact: 
date: 2025-10-29
deciders: 
consulted: 
informed: 
---

# Malware Scanning

## Security Requirement Statement
Uploaded files must be scanned for malware before being accepted onto the platform.

## Control Classification
- **Timing Control Category**: Preventive
- **Nature Control Category**: Technical
- **Status**: Identified
- **Date Identified**: 2025-10-29
- **Date First Implemented**: TBD
- **Date Last Reviewed**: 2025-10-29
- **Date Retired**: N/A

## Replacement Control
N/A - Initial implementation of comprehensive malware scanning system

## Implementation Approach
Multi-layered security approach combining Microsoft Defender for Storage with Edgescan vulnerability management for comprehensive file security validation.

**Current Azure Blob Storage Integration:**
- Files uploaded directly to Azure Blob Storage using SAS tokens (valet keys)
- Microsoft Defender for Storage automatically scans uploaded blobs
- Post-upload scanning with malicious file deletion and version rollback
- Blob versioning enforced to support rollback to previous clean versions

**Edgescan Integration (Planned):**
- Automated vulnerability scanning for application-level security
- Manual penetration testing services for comprehensive security assessment
- Continuous monitoring for emerging threats and vulnerabilities

## Compensating Controls
- Client-side file validation (type, size, dimensions) before upload
- Blob versioning with automatic rollback to previous clean versions
- Short-lived SAS tokens with time-bound access restrictions
- File type restrictions (JPEG, PNG for images; specific formats for documents)
- Size limitations (2MB max for profile images)
- Quarantine period where files exist but aren't immediately accessible

## Context and Problem Statement
ShareThrift allows users to upload various file types including profile photos, listing images, and potentially documents. The platform uses Azure Blob Storage for file storage with direct client uploads for performance and scalability.

**Current File Upload Capabilities:**
- **Profile Images**: JPEG/PNG format, 2MB maximum size
- **Listing Photos**: Multiple images per listing stored in Azure Blob Storage
- **Direct Upload Flow**: Frontend → SAS token request → Direct Azure upload → Backend processing

**Security Challenges:**
- Files temporarily exist in storage before malware scanning completes
- Potential bypass of client-side restrictions by sophisticated users
- Risk of malicious file uploads affecting platform integrity
- Need for immediate response to detected threats

## Technical Requirements
**Current Implementation (Azure Defender):**
- Microsoft Defender for Storage integration with Azure Blob Storage
- Automatic malware signature detection for known threats
- Embedded script and suspicious pattern detection
- Post-upload scanning with tag-based result tracking (`No threats found` or `Malicious`)

**Required Enhancements:**
- Pre-upload scanning capabilities to reduce risk window
- Enhanced backend permission enforcement before SAS token issuance
- Integration with ServiceBlobStorage for secure file management
- Real-time threat response and notification system

**Edgescan Integration Requirements:**
- Automated vulnerability scanning of file upload endpoints
- Regular penetration testing of upload security mechanisms
- Continuous monitoring for new attack vectors and bypass techniques
- Compliance reporting and vulnerability remediation tracking

**File Handling Workflow:**
1. Client-side validation (type, size, dimensions)
2. Backend SAS token generation with permission validation
3. Direct upload to Azure Blob Storage with metadata/tags
4. Microsoft Defender scanning and threat assessment
5. Automatic deletion/rollback for malicious files
6. Backend processing and reference persistence for clean files

## Success Criteria
- Zero malicious files successfully stored long-term in platform storage
- &lt;1 minute scanning time for uploaded files before availability
- 99.9% uptime for file upload and scanning services
- Automatic remediation (delete/rollback) for 100% of detected threats
- Integration with existing Azure Blob Storage and SAS token infrastructure
- Successful Edgescan vulnerability assessments with no critical findings
- Compliance with file storage retention policies (profile images indefinite, listing images tied to listing lifecycle)
- Performance impact &lt;5% on upload times due to security measures