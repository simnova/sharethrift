trigger:
  branches:
    include:
      - main
  paths:
    include:
      - docusaurus

pr:
  branches:
    include:
      - main
  paths:
    include:
      - docusaurus     

pool:
  vmImage: ubuntu-latest

variables:
  - group: github-credential-sharethrift

steps:
  - checkout: self
    persistCredentials: true

  - task: Cache@2
    displayName: 'NPM: Restore Cache'
    inputs:
      key: 'npm | "$(Agent.OS)" | $(Build.SourcesDirectory)/package-lock.json'
      restoreKeys: |
          npm | "$(Agent.OS)"
      path: $(npm_config_cache)

  - task: UseNode@1
    inputs:
      version: '22.x'
    displayName: 'Install Node.js'

  - task: Bash@3
    displayName: 'Install, Build, and Deploy'
    inputs:
      targetType: 'inline'
      script: |
        # Debug variable availability
        echo "GH_NAME: $(GH_NAME)"
        echo "GH_EMAIL: $(GH_EMAIL)"
        echo "GH_TOKEN: $(GH_TOKEN)"
        echo "Token length: ${#GH_TOKEN}"

        if [ -z "$(GH_TOKEN)" ]; then
          echo "Error: GH_TOKEN is empty or not loaded. Please check the variable group configuration."
          exit 1
        fi

        git config --global user.name "$(GH_NAME:-Azure Pipelines)"
        git config --global user.email "$(GH_EMAIL:-azure-pipelines@example.com)"
        npm install
        # npm ci
        npm run deploy || {
          GIT_USER=$(GH_NAME)
          echo "Default credentials failed, using explicit credentials"
          git config --global credential.helper 'cache --timeout=300'
          echo "protocol=https" | git credential approve
          echo "host=github.com" | git credential approve
          echo "username=$(GH_NAME)" | git credential approve
          echo "password=$(GH_TOKEN)" | git credential approve
          npm run deploy
        }